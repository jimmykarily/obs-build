
#################################################################
#
# Docker specific functions.
#
# Author: TODO
#
################################################################
#
# Copyright (c) 2017 SUSE Linux Products GmbH
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 or 3 as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program (see the file COPYING); if not, write to the
# Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA
#
################################################################

recipe_setup_docker() {
  TOPDIR="/docker_sources"
  mkdir -p "$BUILD_ROOT$TOPDIR/SOURCES"
  # Also copy the repos dir
	cp -rp "$MYSRCDIR"/* $BUILD_ROOT$TOPDIR/SOURCES/
}

recipe_prepare_docker() {
    :
}

# Variables:
# $BUILD_ROOT is the chroot
# $TOPDIR/SOURCES includes the docker sources
# $TOPDIR/$DOCKERIMAGE_ROOT where docker will be called
# $RECIPEFILE the name of the Dockerfile

recipe_build_docker() {
    echo "Starting docker service"
    systemctl start docker

    # TODO [TBD] What about the tag?
    # The imported image comes with a tag (merged in the tarball).
    # The user should make sure that this tag matches the one in the Dockerfile.
    echo "Importing images to docker from /var/lib/docker_base_images"
    for image in /var/lib/docker_base_images/*; do
      echo "Importing '$image' in docker"
      docker import $image
    done

    # Start the local zypper repository
    # TODO [TBD] Should we inject the OBS_REPOSITORY_URL in the Dockerfile as described in
    # the following link or is this a user's responsibility?
    #  https://github.com/SUSE/cloudfoundry/blob/NativeDockerInOBS_research_results/NativeDockerInOBS.md
    # TODO [TBD] What about SLES? Are dependencies fetched automatically from osc/OBS?
    #  What about registration?

    # This is where the downloaded dependencies live
    REPOPATH=$BUILD_ROOT$TOPDIR/SOURCES/$REPODIR
    # Prepare the zypper repository
    # TODO: Handle other distribution repositories as well (deb, arch etc)
    createrepo  $REPOPATH
    pushd $REPOPATH
    # TODO How does Python end up here? Maybe we need it to be a "default"
    # dependency for Dockerfiles or something like that.
    python -m SimpleHTTPServer 8080 &
    HTTP_SERVER_PID=$!
    popd

    # Build the repository url
    # TODO: "/bin/ip" comes from iproute2 package on openSUSE. Is that always
    # available in the building machine?
    default_interface=$(ip route list | grep default | cut -d' ' -f5)
    interface_ip=$(ip addr show $default_interface | grep "inet " | tr -s " " | cut -d' ' -f3 | cut -d'/' -f1)
    REPO_URL=http://$interface_ip:8080/

    echo "Building image"
    docker build -t obs_image --build-arg obs_repository_url=$REPO_URL $BUILD_ROOT$TOPDIR/SOURCES/

    # Save the resulting image to a tarball.
    mkdir $BUILD_ROOT$TOPDIR/DOCKER/
    docker save --output $BUILD_ROOT$TOPDIR/DOCKER/obs_image.tar obs_image

    echo "Stopping local repository server"
    kill $HTTP_SERVER_PID

    BUILD_SUCCEEDED=true
}

recipe_resultdirs_docker() {
    # TODO: Implement this to copy the results outside a VM
    :
}

# Local Variables:
# mode: Shell-script
# End:
